//https://leetcode.com/problems/count-k-reducible-numbers-less-than-n/
struct Solution;

const MOD: u32 = 1_000_000_007;

impl Solution {
    pub fn count_k_reducible_numbers(s: String, k: i32) -> i32 {
        let n = s.len();
        let mut count_ones: i32 = 0;
        let bits: Vec<i32> = s
            .chars()
            .map(|c| {
                if c == '1' {
                    count_ones += 1;
                    return 1;
                }
                0
            })
            .collect();
        let fixed_size = n + 1;
        //PreCompute Steps
        let mut steps = vec![0; fixed_size];
        for i in 2..n {
            steps[i] = 1 + steps[i.count_ones() as usize];
        }
        let mut answer = 0;
        let mut memo = vec![vec![0; fixed_size]; 2];
        for &bit in bits.iter().rev() {
            memo[0][n] = 1;
            memo[1][n] = 1;
            let mut memo_curr = vec![vec![0; fixed_size]; 2];
            for ones in (0..n).rev() {
                if memo[0][ones + 1] == 0 {
                    continue;
                }
                //tight=0
                memo_curr[0][ones] =
                    ((memo_curr[0][ones] + memo[0][ones]) % MOD + memo[0][ones + 1]) % MOD;
                //tight=1
                //c_bit=0
                memo_curr[1][ones] =
                    (memo_curr[1][ones] + memo[if 0 == bit { 1 } else { 0 }][ones]) % MOD;
                //c_bit=0
                if bit == 0 {
                    continue;
                }
                let n_tight = if 1 == bit { 1 } else { 0 };
                memo_curr[1][ones] =
                    (memo_curr[1][ones] + memo[if 1 == bit { 1 } else { 0 }][ones + 1]) % MOD;
            }
            memo = memo_curr;
        }

        for i in 0..s.len() {
            if steps[i] < k as usize {
                if memo[1][n - i] > 0 && i == count_ones as usize {
                    memo[1][n - i] -= 1;
                }
                answer = (answer + memo[1][n - i]) % MOD;
            }
        }

        answer as i32
    }
}

fn main() {}

#[cfg(test)]
mod tests {
    //Testcases
    fn testcases() -> Vec<(String, i32, i32)> {
        vec![
            ("111".to_string(), 1, 3),
            ("1000".to_string(), 2, 6),
            ("1011".to_string(), 2, 9),
            ("1111".to_string(), 2, 10),
            ("1".to_string(), 3, 0),
            ("11111100100010011000111100".to_string(), 3, 37279667),
            ("1001110101011001010010101011100101010111001010100101110001010100111010100101011100010101010011101010010101110010101001011100101010010111010010101110010101001011".to_string(),5, 839055184),
            ("11110010011010100111100001010110011101010101110010100101011110001010100100110101110010100111010001110101001110101011001010010101011100101010111001010100101110001010100111010100101011100010101010011101010010101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110101".to_string(), 5, 904596205),
            ("1101010010101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001111100001010110011101010101110010100101011110001010100100110101110010100111010001110101001110101011001010010101011100101010111001010100101110001010100111010100101011100010101010011101010010101110010101001011100101010010111010010101110010101001011100101010111001010100101110010101001011100101010010111010010101110010101001011100101010111001010100101111".to_string(),5,245029421),
            ("11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111".to_string(), 4,901514731)
        ]
    }

    use super::Solution;
    #[test]
    fn test_count_k_reducible_numbers() {
        for (s, k, want) in testcases().into_iter() {
            assert_eq!(Solution::count_k_reducible_numbers(s, k), want);
        }
    }
}
